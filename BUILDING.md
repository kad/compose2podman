# Building and Releasing compose2podman

> **⚠️ PROOF-OF-CONCEPT PROJECT**
>
> This project was completely generated by GitHub Copilot as a demonstration.
> It is NOT production-ready and has NOT been tested with real-world data.

This document describes how to build and release compose2podman.

## Building Locally

### Simple Build

```bash
make build
```

This creates a `compose2podman` binary in the current directory.

### Build with Version Information

```bash
make build-version
```

This embeds version, commit, and build date into the binary using ldflags.

### Multi-Platform Build

```bash
make build-all
```

Builds for common platforms:
- Linux (amd64, arm64)
- macOS (amd64, arm64)
- Windows (amd64)

Binaries are placed in the `dist/` directory.

## Using GoReleaser

GoReleaser automates the release process, creating binaries, archives, and packages for multiple platforms.

### Prerequisites

Install GoReleaser:

```bash
go install github.com/goreleaser/goreleaser@latest
```

Or on Linux:

```bash
# Debian/Ubuntu
echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
sudo apt update
sudo apt install goreleaser

# Fedora/RHEL
echo '[goreleaser]
name=GoReleaser
baseurl=https://repo.goreleaser.com/yum/
enabled=1
gpgcheck=0' | sudo tee /etc/yum.repos.d/goreleaser.repo
sudo yum install goreleaser
```

### Test Release Locally

Build a snapshot release without publishing:

```bash
make snapshot
```

Or directly:

```bash
goreleaser release --snapshot --clean --skip=publish
```

This creates:
- Binaries for all platforms
- Archives (.tar.gz, .zip)
- Linux packages (.deb, .rpm, .apk, .pkg.tar.zst)
- Checksums

All outputs are in the `dist/` directory.

### Check Configuration

Verify GoReleaser configuration:

```bash
make release-check
```

Or:

```bash
goreleaser check
```

### What Gets Built

GoReleaser builds for:

**Operating Systems:**
- Linux
- macOS (Darwin)
- Windows
- FreeBSD

**Architectures:**
- amd64 (x86_64)
- arm64 (aarch64)
- arm (v6, v7)
- 386 (x86)

**Package Formats:**
- `.tar.gz` archives (Unix)
- `.zip` archives (Windows)
- `.deb` packages (Debian/Ubuntu)
- `.rpm` packages (RHEL/Fedora/CentOS)
- `.apk` packages (Alpine)
- `.pkg.tar.zst` packages (Arch Linux)

## Creating a Release

### Prerequisites

1. Clean working directory:
   ```bash
   git status
   ```

2. All tests passing:
   ```bash
   make test
   ```

3. Version decided (semantic versioning: `vMAJOR.MINOR.PATCH`)

### Release Process

1. **Create and push a version tag:**

   ```bash
   git tag -a v0.2.0 -m "Release v0.2.0"
   git push origin v0.2.0
   ```

2. **GitHub Actions automatically:**
   - Runs tests
   - Builds for all platforms
   - Creates packages
   - Uploads to GitHub Releases
   - Generates release notes from commits

3. **Manual release (if needed):**

   ```bash
   # Set GitHub token
   export GITHUB_TOKEN="your-github-token"
   
   # Run release
   goreleaser release --clean
   ```

### Environment Variables

For a full release, you may need:

```bash
# Required for GitHub releases
export GITHUB_TOKEN="github_pat_..."

# Optional: For Homebrew tap
export HOMEBREW_TAP_GITHUB_TOKEN="github_pat_..."

# Optional: For signing
export GPG_FINGERPRINT="your-gpg-key-id"
export GPG_PASSWORD="your-gpg-password"
```

## Release Artifacts

Each release includes:

### Binaries
- Raw binaries for all platforms in archives

### Archives
- Source code
- Documentation (README, CONTRIBUTING, EXAMPLES)
- Example files (testdata/)
- LICENSE

### Linux Packages
- `.deb` - Debian/Ubuntu
- `.rpm` - RHEL/Fedora/CentOS
- `.apk` - Alpine Linux
- `.pkg.tar.zst` - Arch Linux

### Checksums
- `checksums.txt` - SHA256 checksums for verification

### Docker Images (optional)
- `ghcr.io/kad/compose2podman:VERSION`
- `ghcr.io/kad/compose2podman:latest`

## Versioning

We follow [Semantic Versioning](https://semver.org/):

- `MAJOR` - Incompatible API changes
- `MINOR` - New functionality (backwards compatible)
- `PATCH` - Bug fixes (backwards compatible)

Examples:
- `v0.1.0` - Initial release
- `v0.2.0` - New features added
- `v0.2.1` - Bug fix
- `v1.0.0` - First stable release

## Changelog

Changelog is automatically generated from commit messages.

Use [Conventional Commits](https://www.conventionalcommits.org/):

- `feat:` - New features (appear in Features section)
- `fix:` - Bug fixes (appear in Bug Fixes section)
- `docs:` - Documentation (excluded from changelog)
- `test:` - Tests (excluded from changelog)
- `chore:` - Maintenance (excluded from changelog)

Example:
```bash
git commit -m "feat: add support for healthchecks in Kubernetes output"
git commit -m "fix: handle empty environment variables correctly"
```

## Testing a Release

After building with GoReleaser:

### Test the Binary

```bash
# Extract and test
tar -xzf dist/compose2podman_*_linux_amd64.tar.gz
./compose2podman -version
./compose2podman -input testdata/simple.yaml -type kube
```

### Test a Package

```bash
# Debian/Ubuntu
sudo dpkg -i dist/compose2podman_*_linux_amd64.deb
compose2podman -version
sudo dpkg -r compose2podman

# RHEL/Fedora
sudo rpm -i dist/compose2podman_*_linux_amd64.rpm
compose2podman -version
sudo rpm -e compose2podman
```

## Troubleshooting

### "command not found" after installing package

Packages install to `/usr/bin/`, which should be in your PATH.

```bash
which compose2podman
/usr/bin/compose2podman
```

### Version shows "dev"

The binary was built without version information. Use:
- `make build-version` for local builds
- GoReleaser for releases (embeds version automatically)

### GoReleaser fails with "dirty git state"

Commit or stash all changes:

```bash
git status
git add -A
git commit -m "your changes"
```

### Missing dependencies in packages

Update the `nfpms` section in `.goreleaser.yml` to add dependencies.

## References

- [GoReleaser Documentation](https://goreleaser.com/)
- [Semantic Versioning](https://semver.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [GitHub Releases](https://docs.github.com/en/repositories/releasing-projects-on-github)
